# Rosefire Javascript SDK

![Javascript](https://img.shields.io/badge/javascript-v2.1.0-orange.svg)

## Setup 

This project can be downloaded via npm by typing in the following command. Alternatively, you can just download the zip
of this repo and grab the file you need.
```
npm install git+https://ada.csse.rose-hulman.edu/rosefire/javascript-sdk.git#2.1.0 --save
```

## Plain Javascript SDK

If you using plain javascript, or creating your own binding into some framework, you'll
want to use these instructions. If you're using angular, see below.

**Step 1:** Load the module

Make sure you include this script in the dist folder of the module in your html page.
```html
<script src="node_modules/rosefire/dist/js/rosefire.min.js"></script>
```

### Usage with Firebase

**Step 2:** You're all ready to authenticate if you use [Firebase's plain javascript SDK](https://www.firebase.com/docs/web/api/).

```javascript
// Please note this needs to be the result of a user interaction
// (like a button click) otherwise it will get blocked as a popup
Rosefire.signIn("<REGISTRY_TOKEN>", function(err, rfUser) {
  if (err) {
    // User not logged in!
    return;
  }
 firebase.auth().signInWithCustomToken(rfUser.token).then(function(authData) {
    // User logged in successfully 
 }, function(error) {
    // User not logged in!
  });
});
```

### Standalone Usage

```javascript
// Please note this needs to be the result of a user interaction
// (like a button click) otherwise it will get blocked as a popup
Rosefire.signIn("<REGISTRY_TOKEN>", function(err, rfUser) {
  if (err) {
    // User not logged in!
    return;
  } else {
    // Use the token to authenticate with your server
    // checkout the server SDKs for more information.
  }
});
```

## AngularJS SDK

If you're using angular in your project then there are bindings to make integration
into your project easier.

**Step 1:** Load the module

Make sure you include this script in the dist folder of the module in your html page.
```html
<!-- Make sure you load angular first! -->
<script src="node_modules/rosefire/dist/js/rosefire-angular.min.js"></script>
```

### Usage with Firebase

**Step 2:** You're all ready to authenticate if you use [AngularFire](https://www.firebase.com/docs/web/libraries/angular/).

```javascript
angular.module('app', ['firebase', 'rosefire']) 
  .controller('LoginCtrl', function($firebaseAuth, Rosefire, $scope, $q) {
    var auth = $firebaseAuth();
    $scope.login = function() {
      Rosefire.signIn("<REGISTRY_TOKEN>")
        .then(function(rfUser) {
          return auth.$signInWithCustomToken(rfUser.token);
        })
        .then(function(authData) {
          // User logged in!
        })
        .catch(function(err) {
          // User not logged in!
        });
    };
  });
```

### Standalone Usage

```javascript
angular.module('app', ['rosefire']) 
  .controller('LoginCtrl', function(Rosefire, $scope) {
    $scope.login = function() {
      Rosefire.signIn("<REGISTRY_TOKEN>")
        .then(function(rfUser) {
          // User logged in!
          // Use the token to authenticate with your server
          // checkout the server SDKs for more information.
        }, function(err) {
          // User not logged in!
        });
    };
  });
```

## Angular2 and Typescript Support

**Step 1: Setup and Installation**


This assumes that you are using the [Angular CLI Tool](https://github.com/angular/angular-cli#angular-cli) 
to manage and create your project. 

Once you've setup your project using `ng new <app-name>` you'll then need to run the npm install command.
```
npm install git+https://ada.csse.rose-hulman.edu/rosefire/javascript-sdk.git#2.1.0 --save
```

Once you've installed the SDK, you'll need to include the file in the NPM vendor files list in
`angular-cli-build.js` file in the root of the project.

You'll need to add the last line so the list looks something like this:

```javascript
vendorNpmFiles: [
  'systemjs/dist/system-polyfills.js',
  'systemjs/dist/system.src.js',
  'zone.js/dist/**/*.+(js|js.map)',
  'es6-shim/es6-shim.js',
  'reflect-metadata/**/*.+(ts|js|js.map)',
  'rxjs/**/*.+(js|js.map)',
  '@angular/**/*.+(js|js.map)',
  // above are the existing entries
  // below are the AngularFire entries
  'angularfire2/*/.js', // Added when doing AngularFire setup
  'firebase/lib/*.js', // Added when doing AngularFire setup
  'rosefire/dist/js/rosefire.min.js' // This is the line you need to add now!
]
```

Then you still need to modify your `system-config.ts` file to include rosefire in your map:

```typescript
/** Map relative paths to URLs. */
const map: any = {
  'rosefire': 'vendor/rosefire/dist/js/rosefire.min.js',
};

```

Lastly, to make the Typescript compiler aware of the globally attached Rosefire object,
we need to install the correct typings, use the following command to install the Rosefire
typings

```bash
typings install file:node_modules/rosefire/rosefire.d.ts --save --global && typings install
```

After that, you can import Rosefire into the Typescript file that you're
using via:

```typescript
import 'rosefire';
```

**Step 2: Usage**

### Angularfire2

Once you've setup Angularfire2 according to [their documentation](https://github.com/angular/angularfire2/blob/master/docs/1-install-and-setup.md)
you can use it in conjuction with Rosefire. (Please note at the time of writing [this won't work](https://github.com/angular/angularfire2/issues/286).)

```typescript
Rosefire.signIn(environment.registryToken, (error, rfUser: RosefireUser) => {
  if (error) {
    console.error(error);
    return;
  }
  this.af.auth.login(rfUser.token, {
    method: AuthMethods.CustomToken,
    provider: AuthProviders.Custom,
  });
});
```

### Standalone Usage

```typescript
Rosefire.signIn("<REGISTRY_TOKEN>", (error, rfUser: RosefireUser) => {
  if (error) {
    // User not logged in!
    return;
  } else {
    // Use the token to authenticate with your server
    // checkout the server SDKs for more information.
  }
});
```
